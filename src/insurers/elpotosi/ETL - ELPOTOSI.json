{
  "name": "ETL - ELPOTOSI",
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -1376,
        544
      ],
      "id": "11fa420a-c558-41ac-9a52-1bda8acc47c1",
      "name": "When clicking â€˜Execute workflowâ€™"
    },
    {
      "parameters": {
        "jsCode": "// ETL EL POTOSÃ - NORMALIZACIÃ“N\nconst crypto = require('crypto');\nconst ASEGURADORA = 'ELPOTOSI';\n\n// DICCIONARIO EXPANDIDO DE MARCAS\nconst MARCAS_CANONICAS = {\n    // Alemanas Premium\n    'MERCEDES-BENZ': ['MERCEDES', 'MERCEDES BENZ', 'BENZ', 'MB', 'MERCEDES-BENZ'],\n    'BMW': ['BMW', 'BAYERISCHE MOTOREN WERKE', 'B.M.W.'],\n    'AUDI': ['AUDI', 'AU'],\n    'PORSCHE': ['PORSCHE', 'POR'],\n    'VOLKSWAGEN': ['VW', 'VOLKS', 'VOLKSWAGON', 'V.W.', 'VOLKSWAGEN'],\n    'MINI': ['MINI', 'MINI COOPER'],\n    \n    // Americanas\n    'CHEVROLET': ['CHEVY', 'CHEV', 'GM', 'GENERAL MOTORS', 'CHEVROLET'],\n    'FORD': ['FORD', 'FORD MOTOR', 'FMC'],\n    'CHRYSLER': ['CHRYSLER', 'CHR'],\n    'NISSAN': ['NISSAN', 'DATSUN', 'NISS', 'NIS'],\n    'DODGE': ['DODGE', 'DOD'],\n    'JEEP': ['JEEP', 'JEP'],\n    'RAM': ['RAM', 'DODGE RAM'],\n    'CADILLAC': ['CADILLAC', 'CAD'],\n    'BUICK': ['BUICK', 'BUI'],\n    'GMC': ['GMC', 'GENERAL MOTORS CORP'],\n    'LINCOLN': ['LINCOLN', 'LIN'],\n    'TESLA': ['TESLA', 'TES'],\n    \n    // Japonesas\n    'TOYOTA': ['TOYOTA', 'TOY', 'TOYOT'],\n    'HONDA': ['HONDA', 'HDA', 'HON'],\n    'MAZDA': ['MAZDA', 'MZD', 'MAZ'],\n    'MITSUBISHI': ['MITSUBISHI', 'MIT', 'MITS', 'MITSU'],\n    'SUZUKI': ['SUZUKI', 'SZK', 'SUZ'],\n    'SUBARU': ['SUBARU', 'SUB'],\n    'INFINITI': ['INFINITI', 'INF'],\n    'LEXUS': ['LEXUS', 'LEX'],\n    'ACURA': ['ACURA', 'ACU'],\n    \n    // Coreanas\n    'KIA': ['KIA', 'KIA MOTORS', 'KI'],\n    'HYUNDAI': ['HYUNDAI', 'HYU', 'HYUN'],\n    \n    // Europeas Premium\n    'LAND-ROVER': ['LAND ROVER', 'LANDROVER', 'LR'],\n    'JAGUAR': ['JAGUAR', 'JAG'],\n    'ROLLS-ROYCE': ['ROLLS', 'ROLLS ROYCE'],\n    'BENTLEY': ['BENTLEY', 'BEN'],\n    'ASTON-MARTIN': ['ASTON', 'ASTON MARTIN'],\n    'MASERATI': ['MASERATI', 'MAS'],\n    'FERRARI': ['FERRARI', 'FER'],\n    'LAMBORGHINI': ['LAMBORGHINI', 'LAMBO', 'LAM'],\n    'MCLAREN': ['MCLAREN', 'MCL'],\n    'ALFA-ROMEO': ['ALFA', 'ALFA ROMEO', 'ALFAROMEO'],\n    \n    // Europeas Populares\n    'SEAT': ['SEAT', 'ST'],\n    'PEUGEOT': ['PEUGEOT', 'PGT', 'PEUG'],\n    'RENAULT': ['RENAULT', 'RNT', 'REN'],\n    'FIAT': ['FIAT', 'FIA'],\n    'VOLVO': ['VOLVO', 'VOL'],\n    'SMART': ['SMART', 'MERCEDES SMART'],\n    \n    // Chinas Emergentes\n    'BYD': ['BYD', 'BUILD YOUR DREAMS'],\n    'GREAT-WALL': ['GREAT WALL', 'GREAT WALL MOTORS', 'GWM'],\n    'GEELY': ['GEELY', 'GEE'],\n    'HAVAL': ['HAVAL', 'HAV'],\n    'CHANGAN': ['CHANGAN', 'CHA'],\n    'JAC': ['JAC', 'JIANGHUAI'],\n    'DFSK': ['DFSK', 'DONGFENG SOKON'],\n    'BAIC': ['BAIC', 'BEIJING AUTO'],\n    'MG': ['MG', 'MORRIS GARAGES'],\n    \n    // Especiales\n    'CBO': ['CBO'],\n    'ESPECIAL': ['ESPECIAL', 'ESP'],\n    'MULTIMARCA': ['MULTIMARCA', 'MULTI']\n};\n\n// MAPA DE TRANSMISIONES MEJORADO PARA EL POTOSÃ\nconst MAPA_TRANSMISIONES = {\n    'Manual': 'MANUAL',\n    'AutomÃ¡tica': 'AUTO',\n    'DSG': 'DSG',              // Direct Shift Gearbox (VW Group)\n    'DCT': 'DCT',              // Dual Clutch Transmission\n    'CVT': 'CVT',              // Continuously Variable Transmission\n    'Tiptronic': 'TIPTRONIC',  // Tiptronic (VW/Audi)\n    'Selespeed': 'SELESPEED',  // Selespeed (Alfa Romeo)\n    'Especial': 'ESPECIAL',\n    'No especificada': 'NO_ESPECIFICADA'\n};\n\n// FUNCIONES DE NORMALIZACIÃ“N\nfunction normalizarTexto(texto) {\n    if (!texto) return '';\n    return String(texto)\n        .toUpperCase()\n        .normalize('NFD')\n        .replace(/[\\u0300-\\u036f]/g, '')\n        .replace(/[^A-Z0-9\\s]/g, '')\n        .replace(/\\s+/g, ' ')\n        .trim();\n}\n\nfunction normalizarMarca(marca) {\n    if (!marca) return '';\n    const marcaNormalizada = normalizarTexto(marca);\n    \n    for (const [canonical, sinonimos] of Object.entries(MARCAS_CANONICAS)) {\n        if (sinonimos.includes(marcaNormalizada) || marcaNormalizada === canonical.replace('-', ' ')) {\n            return canonical;\n        }\n    }\n    return marcaNormalizada;\n}\n\nfunction normalizarVersion(version) {\n    if (!version) return '';\n    return String(version)\n        .toUpperCase()\n        .normalize('NFD')\n        .replace(/[\\u0300-\\u036f]/g, '')\n        // Eliminar informaciÃ³n tÃ©cnica especÃ­fica de El PotosÃ­\n        .replace(/\\bL\\d+\\b/gi, '')                    // L4, L6\n        .replace(/\\b[VI]\\d+\\b/gi, '')                 // V6, V8, I4\n        .replace(/\\b\\d+\\.\\d+\\s*L?\\b/gi, '')           // 1.5L, 2.0, 2.4, 3.5L\n        .replace(/\\b\\d+L\\b/gi, '')                    // 2L, 4L\n        .replace(/\\b\\d+\\s*CIL\\.?\\b/gi, '')            // 4CIL, 6 CIL\n        .replace(/\\b\\d+\\s*CL\\b/gi, '')                // 3CL (cilindros)\n        .replace(/\\b\\d+\\s*HP\\b/gi, '')                // 82 HP\n        .replace(/\\b\\d+\\s*PTAS?\\b/gi, '')             // 4 PTAS, 5 PTA\n        .replace(/\\b\\d+\\s*OCUP\\b/gi, '')              // 5 OCUP\n        .replace(/\\bN\\/A\\b/gi, '')                    // N/A\n        .replace(/\\bTON\\b/gi, '')                     // TON\n        .replace(/\\bAÃ‘O:?\\s*\\d+\\b/gi, '')             // AÃ±o: 2010\n        // Eliminar equipamiento especÃ­fico\n        .replace(/\\bABS\\b/gi, '')                     // ABS\n        .replace(/\\bA\\/A\\b/gi, '')                    // A/A (aire acondicionado)\n        .replace(/\\bE\\/E\\b/gi, '')                    // E/E (elevadores elÃ©ctricos)\n        .replace(/\\bTELA\\b/gi, '')                    // TELA\n        .replace(/\\bPIEL\\b/gi, '')                    // PIEL\n        .replace(/\\bQ\\/C\\b/gi, '')                    // Q/C (quemacocos)\n        .replace(/\\bB\\/A\\b/gi, '')                    // B/A (bolsa de aire)\n        .replace(/\\bCRISTAL\\b/gi, '')                 // CRISTAL\n        // Eliminar informaciÃ³n de transmisiÃ³n de la versiÃ³n (ya se captura aparte)\n        .replace(/\\bSTD\\b/gi, '')                     // STD\n        .replace(/\\bAUT\\b/gi, '')                     // AUT\n        .replace(/\\bMT\\b/gi, '')                      // MT\n        .replace(/\\bAT\\b/gi, '')                      // AT\n        .replace(/\\bA\\/S\\b/gi, '')                    // A/S\n        // Limpiar caracteres especiales\n        .replace(/[^A-Z0-9\\s-]/g, '')\n        .replace(/\\s+/g, ' ')\n        .trim();\n}\n\nfunction normalizarVersionUniversal(versionCompleta, versionCorta, transmisionNorm) {\n    // En El PotosÃ­, VersionCorta parece ser mÃ¡s descriptiva en muchos casos\n    const versionParaNormalizar = (versionCorta && \n                                   versionCorta.trim() !== '' && \n                                   !versionCorta.includes('N/A')) \n                                   ? versionCorta : versionCompleta;\n    \n    let versionNorm = normalizarVersion(versionParaNormalizar);\n    \n    // Extraer versiones comunes de El PotosÃ­\n    const patrones = [\n        /\\b(EXECUTIVE|EJECUTIVE)\\b/gi,\n        /\\b(SPORT|SPORTS|SPORTY)\\b/gi,\n        /\\b(STYLE)\\b/gi,\n        /\\b(ATTRACTION|ATTRACTION PLUS)\\b/gi,\n        /\\b(COMFORT|CONFORT)\\b/gi,\n        /\\b(PREMIUM|PREM)\\b/gi,\n        /\\b(LUXURY|LUX|LUJO)\\b/gi,\n        /\\b(ELITE)\\b/gi,\n        /\\b(LIMITED|LTD|LIMITADA)\\b/gi,\n        /\\b(BASE|BASICO|BASICA)\\b/gi,\n        /\\b(CABRIOLET|CABRIO|CONVERTIBLE|CONV)\\b/gi,\n        /\\b(COUPE|COUP)\\b/gi,\n        /\\b(SEDAN)\\b/gi,\n        /\\b(HATCHBACK|HATCH)\\b/gi,\n        /\\b(EXCLUSIVE)\\b/gi,\n        /\\b(ADVANCE|ADVANCED)\\b/gi,\n        /\\b(SELESPEED)\\b/gi,\n        /\\b(TRIPTONIC|TIPTRONIC)\\b/gi\n    ];\n    \n    for (const patron of patrones) {\n        const match = versionNorm.match(patron);\n        if (match) {\n            let version = match[0].toUpperCase().replace(/\\s+/g, '-');\n            // Normalizar variaciones\n            if (version.includes('EJECUTIVE')) return 'EXECUTIVE';\n            if (version.includes('ATTRACTION-PLUS')) return 'ATTRACTION-PLUS';\n            if (version.includes('ATTRACTION')) return 'ATTRACTION';\n            if (version.includes('SPORT')) return 'SPORT';\n            if (version.includes('STYLE')) return 'STYLE';\n            if (version.includes('COMFORT') || version.includes('CONFORT')) return 'COMFORT';\n            if (version.includes('PREMIUM') || version.includes('PREM')) return 'PREMIUM';\n            if (version.includes('LUXURY') || version.includes('LUX') || version.includes('LUJO')) return 'LUXURY';\n            if (version.includes('ELITE')) return 'ELITE';\n            if (version.includes('LIMITED') || version.includes('LTD') || version.includes('LIMITADA')) return 'LIMITED';\n            if (version.includes('BASE') || version.includes('BASICO') || version.includes('BASICA')) return 'BASE';\n            if (version.includes('CABRIOLET') || version.includes('CABRIO') || version.includes('CONVERTIBLE') || version.includes('CONV')) return 'CABRIOLET';\n            if (version.includes('COUPE') || version.includes('COUP')) return 'COUPE';\n            if (version.includes('SEDAN')) return 'SEDAN';\n            if (version.includes('HATCHBACK') || version.includes('HATCH')) return 'HATCHBACK';\n            if (version.includes('EXCLUSIVE')) return 'EXCLUSIVE';\n            if (version.includes('ADVANCE')) return 'ADVANCE';\n            if (version.includes('SELESPEED')) return 'SELESPEED';\n            if (version.includes('TRIPTONIC') || version.includes('TIPTRONIC')) return 'TIPTRONIC';\n            return version;\n        }\n    }\n    \n    // Si no encuentra patrÃ³n, usar la primera palabra significativa\n    const palabras = versionNorm.split(' ').filter(p => p.length > 2 && !['AÃ‘OS', 'AÃ‘O'].includes(p));\n    return palabras.length > 0 ? palabras[0] : 'STANDARD';\n}\n\nfunction normalizarTransmision(transmisionDesc) {\n    if (!transmisionDesc) return 'NO_ESPECIFICADA';\n    return MAPA_TRANSMISIONES[transmisionDesc] || 'NO_ESPECIFICADA';\n}\n\n// FUNCIÃ“N MEJORADA: Detectar transmisiÃ³n desde descripciÃ³n si no estÃ¡ especificada\nfunction detectarTransmisionDesdeDescripcion(versionCompleta) {\n    if (!versionCompleta) return null;\n    \n    const descripcionUpper = versionCompleta.toUpperCase();\n    \n    // Orden de prioridad para detecciÃ³n - El PotosÃ­ usa mucho DSG\n    if (descripcionUpper.includes('DSG')) return 'DSG';\n    if (descripcionUpper.includes('DCT')) return 'DCT';\n    if (descripcionUpper.includes('CVT')) return 'CVT';\n    if (descripcionUpper.includes('TIPTRONIC') || descripcionUpper.includes('TRIPTONIC')) return 'TIPTRONIC';\n    if (descripcionUpper.includes('SELESPEED')) return 'SELESPEED';\n    if (descripcionUpper.includes('STRONIC')) return 'DSG';  // Audi usa S-Tronic\n    if (descripcionUpper.includes('MULTITRONIC')) return 'CVT';  // Audi usa Multitronic\n    // Patrones de automÃ¡tica\n    if (descripcionUpper.includes('AUT') || descripcionUpper.includes('AUTO')) return 'AUTO';\n    if (descripcionUpper.includes(' AT ') || descripcionUpper.includes('AT,')) return 'AUTO';\n    if (descripcionUpper.includes('A/S')) return 'AUTO';\n    // Patrones de manual\n    if (descripcionUpper.includes('STD')) return 'MANUAL';\n    if (descripcionUpper.includes(' MT ') || descripcionUpper.includes('MT ') || descripcionUpper.includes(' MT,')) return 'MANUAL';\n    if (descripcionUpper.includes('MAN')) return 'MANUAL';\n    \n    return null;\n}\n\nfunction generarHash(...componentes) {\n    const textoHash = componentes\n        .map(c => String(c || '').toUpperCase().trim())\n        .join('|');\n    \n    return crypto\n        .createHash('sha256')\n        .update(textoHash, 'utf8')\n        .digest('hex');\n}\n\n// PROCESAMIENTO PRINCIPAL\nconst items = $input.all();\nconst registros = [];\nconst fechaProceso = new Date().toISOString();\n\nlet estadisticas = {\n    total: 0,\n    conTransmision: 0,\n    sinTransmision: 0,\n    transmisionDetectada: 0,\n    transmisionNoEspecificada: 0,\n    tiposDetectados: {\n        DSG: 0,\n        DCT: 0,\n        CVT: 0,\n        TIPTRONIC: 0,\n        SELESPEED: 0,\n        AUTO: 0,\n        MANUAL: 0\n    }\n};\n\nfor (const item of items) {\n    const data = item.json;\n    \n    if (!data.marca || !data.modelo || !data.aÃ±o) {\n        continue;\n    }\n    \n    estadisticas.total++;\n    \n    const marcaNormalizada = normalizarMarca(data.marca);\n    const modeloNormalizado = normalizarTexto(data.modelo);\n    \n    // MEJORADO: NormalizaciÃ³n de transmisiÃ³n con detecciÃ³n desde descripciÃ³n\n    let transmisionNormalizada = normalizarTransmision(data.transmision_descripcion);\n    \n    // Si la transmisiÃ³n no estÃ¡ especificada, intentar detectarla desde la descripciÃ³n\n    if (transmisionNormalizada === 'NO_ESPECIFICADA' && data.version_completa) {\n        const transmisionDetectada = detectarTransmisionDesdeDescripcion(data.version_completa);\n        if (transmisionDetectada) {\n            transmisionNormalizada = transmisionDetectada;\n            estadisticas.transmisionDetectada++;\n            // Contar tipo detectado\n            if (estadisticas.tiposDetectados[transmisionDetectada]) {\n                estadisticas.tiposDetectados[transmisionDetectada]++;\n            }\n        } else {\n            estadisticas.transmisionNoEspecificada++;\n        }\n    } else if (transmisionNormalizada !== 'NO_ESPECIFICADA') {\n        estadisticas.conTransmision++;\n    }\n    \n    const versionNormalizada = normalizarVersionUniversal(\n        data.version_completa, \n        data.version_corta, \n        transmisionNormalizada\n    );\n    \n    const versionCortaNormalizada = data.version_corta ? \n        normalizarVersionUniversal(data.version_corta, null, transmisionNormalizada) : \n        versionNormalizada;\n    \n    const hashUnico = generarHash(\n        marcaNormalizada,\n        modeloNormalizado,\n        data.aÃ±o,\n        versionNormalizada,\n        transmisionNormalizada\n    );\n    \n    const registro = {\n        hash_unico: hashUnico,\n        marca: data.marca,\n        modelo: data.modelo,\n        aÃ±o: data.aÃ±o,\n        version: data.version_completa,\n        version_corta: data.version_corta || null,\n        transmision_codigo: data.transmision_codigo,\n        transmision_descripcion: data.transmision_descripcion,\n        transmision_normalizada: transmisionNormalizada,\n        transmision_original: data.transmision_original,\n        transmision_detectada_desc: data.transmision_detectada_desc === 1,\n        marca_normalizada: marcaNormalizada,\n        modelo_normalizado: modeloNormalizado,\n        version_normalizada: versionNormalizada,\n        version_corta_normalizada: versionCortaNormalizada,\n        catalogo_marca_id: data.catalogo_marca_id,\n        catalogo_modelo_id: data.catalogo_modelo_id,\n        catalogo_version_id: data.catalogo_version_id || null,\n        origen_carga: 'etl_elpotosi_batch',\n        fecha_proceso: fechaProceso,\n        aseguradora_data: {\n            aseguradora: 'ELPOTOSI',\n            id_original: data.id_original,\n            activo: data.activo !== undefined ? data.activo : 1,\n            fecha_actualizacion: data.fecha_actualizacion,\n            transmision_original: data.transmision_original,\n            transmision_detectada_automaticamente: data.transmision_detectada_desc === 1\n        },\n        hash_components: {\n            marca: marcaNormalizada,\n            modelo: modeloNormalizado,\n            aÃ±o: data.aÃ±o.toString(),\n            version: versionNormalizada,\n            transmision: transmisionNormalizada\n        }\n    };\n    \n    registros.push(registro);\n}\n\nreturn registros;"
      },
      "id": "46cc78f7-05dc-4ed5-935d-6faf85e4186d",
      "name": "Normalize Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -784,
        544
      ]
    },
    {
      "parameters": {
        "content": "## https://zsyapaddgdrnqfdxxzjw.supabase.co\n\n\n\n\n\n\neyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpzeWFwYWRkZ2RybnFmZHh4emp3Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MzI5MTc5MiwiZXhwIjoyMDY4ODY3NzkyfQ.fxsYfEUkFGOP6dyrSxn2RYymcVWWQFi2te8nuJrIOyo\n",
        "width": 288
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -592,
        112
      ],
      "typeVersion": 1,
      "id": "fb9cba4a-ebc5-4c96-b07e-a57e65e98a28",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "jsCode": "// Nodo: Deduplicate Source Data\nconst items = $input.all();\nconst seen = new Map();\n\nfor (const item of items) {\n  const key = `${item.json.marca}|${item.json.modelo}|${item.json.aÃ±o}|${item.json.version_completa}`;\n  \n  if (!seen.has(key) || item.json.fecha_actualizacion > seen.get(key).json.fecha_actualizacion) {\n    seen.set(key, item);\n  }\n}\n\nreturn Array.from(seen.values());"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -976,
        544
      ],
      "id": "0ca8334d-ef84-4401-957f-7ad1a383923f",
      "name": "Deduplicate data"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- =====================================================\n-- QUERY DE EXTRACCIÃ“N PARA EL POTOSÃ\n-- Activos: 23,040 registros (confirmado exacto)\n-- TransmisiÃ³n: 1=MANUAL, 2=AUTO, 0=NULL\n-- =====================================================\nSELECT \n    'ELPOTOSI' as origen_aseguradora,\n    CAST(v.IdVersion as VARCHAR(50)) as id_original,\n    UPPER(LTRIM(RTRIM(ma.Descripcion))) as marca,\n    UPPER(LTRIM(RTRIM(mo.Descripcion))) as modelo,\n    v.Anio as anio,\n    COALESCE(v.VersionCorta, v.Descripcion) as version_original,\n    CASE \n        WHEN v.Transmision = 2 THEN 'AUTO'\n        WHEN v.Transmision = 1 THEN 'MANUAL'\n        ELSE NULL\n    END as transmision,\n    CAST(v.Activo as INT) as activo\nFROM elpotosi.Version v\nINNER JOIN elpotosi.Marca ma ON v.IdMarca = ma.IdMarca\n    AND v.Anio = ma.Anio\n    AND v.TipoVehiculo = ma.TipoVehiculo\nINNER JOIN elpotosi.Modelo mo ON v.IdModelo = mo.IdModelo\n    AND v.IdMarca = mo.IdMarca\n    AND v.Anio = mo.Anio\n    AND v.TipoVehiculo = mo.TipoVehiculo\nWHERE v.Activo = 1\n    AND v.Anio BETWEEN 2000 AND 2030\nORDER BY ma.Descripcion, mo.Descripcion, v.Anio;"
      },
      "id": "bda83c28-b974-4d9c-bdcd-de8ed1759954",
      "name": "Extract ELPOTOSI Data",
      "type": "n8n-nodes-base.microsoftSql",
      "typeVersion": 1,
      "position": [
        -1184,
        544
      ],
      "credentials": {
        "microsoftSql": {
          "id": "LxcRbE0XllWrNCsR",
          "name": "Microsoft SQL account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Nodo: Deduplicate by Hash - CRÃTICO para evitar duplicados\nconst items = $input.all();\nconst uniqueByHash = new Map();\nconst duplicates = new Map();\n\n// Procesar todos los items\nitems.forEach(item => {\n  const hash = item.json.hash_unico;\n  \n  if (!hash) {\n    return;\n  }\n  \n  if (uniqueByHash.has(hash)) {\n    // Contar duplicados\n    if (!duplicates.has(hash)) {\n      duplicates.set(hash, [uniqueByHash.get(hash)]);\n    }\n    duplicates.set(hash, [...duplicates.get(hash), item]);\n  } else {\n    uniqueByHash.set(hash, item);\n  }\n});\n\n// Reportar duplicados encontrados\nif (duplicates.size > 0) {  \n  // Mostrar ejemplos de duplicados\n  let exampleCount = 0;\n  for (const [hash, items] of duplicates.entries()) {\n    if (exampleCount >= 5) break;\n    \n    console.log(`\\nðŸ” Hash duplicado: ${hash.substring(0, 16)}...`);\n    console.log(`   Registros: ${items.length}`);\n    \n    // Mostrar los primeros 2 registros del duplicado\n    items.slice(0, 2).forEach((item, idx) => {\n      const data = item.json;\n    });\n    \n    exampleCount++;\n  }\n  \n  // AnÃ¡lisis de por quÃ© se duplican\n  const duplicateAnalysis = new Map();\n  for (const [hash, items] of duplicates.entries()) {\n    const firstItem = items[0].json;\n    const key = `${firstItem.marca_normalizada}|${firstItem.modelo_normalizado}`;\n    \n    if (!duplicateAnalysis.has(key)) {\n      duplicateAnalysis.set(key, 0);\n    }\n    duplicateAnalysis.set(key, duplicateAnalysis.get(key) + 1);\n  }\n  \n  const sortedAnalysis = Array.from(duplicateAnalysis.entries())\n    .sort((a, b) => b[1] - a[1])\n    .slice(0, 10);\n  \n  sortedAnalysis.forEach(([key, count]) => {\n    console.log(`   ${key}: ${count} hashes duplicados`);\n  });\n}\n\n// EstadÃ­sticas finales\nconst finalItems = Array.from(uniqueByHash.values());\n\nreturn finalItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -576,
        544
      ],
      "id": "7a2be9a5-c96b-4893-8b5c-c292f3e6b42c",
      "name": "Deduplicate by Hash"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        -976,
        752
      ],
      "id": "6fb5f660-3503-49e7-9833-ce9ba656afde",
      "name": "Convert to File"
    }
  ],
  "pinData": {
    "When clicking â€˜Execute workflowâ€™": [
      {
        "json": {}
      }
    ]
  },
  "connections": {
    "When clicking â€˜Execute workflowâ€™": {
      "main": [
        [
          {
            "node": "Extract ELPOTOSI Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalize Data": {
      "main": [
        [
          {
            "node": "Deduplicate by Hash",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Deduplicate data": {
      "main": [
        [
          {
            "node": "Normalize Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract ELPOTOSI Data": {
      "main": [
        [
          {
            "node": "Convert to File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Deduplicate by Hash": {
      "main": [
        []
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "9fcc05d7-0e6f-489a-80dd-2b69b9866f5f",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "900709ac205bf412bdd7b3d4452073dce9dfbb650e50cd24da57187d1da44e89"
  },
  "id": "8JiXt6pM5KnpAdn0",
  "tags": []
}